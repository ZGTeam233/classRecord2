<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€†è½¬ï¼å­¦éœ¸æ³•åº­è®°å½• - å‘ˆä¸Šè¯æ®ï¼</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=DotGothic16&display=swap" rel="stylesheet">
    
    <style>
        /* --- åŸºç¡€ä¸ä¸»é¢˜å˜é‡ (æ³•åº­ä¸»é¢˜) --- */
        :root {
            --primary-color: #3b5998; /* è¾©æŠ¤æ–¹è“è‰² (æˆæ­¥å ‚) */
            --secondary-color: #cc0000; /* å¼‚è®®çº¢è‰² (å¾¡å‰‘) */
            --header-bg: #444444; /* æ³•åº­æœ¨æ¿æ·±è‰² */
            --wood-dark: #222222;
            --wood-light: #aaaaaa;
            --text-dark: #111111;
            --text-light: #ffffff;
            --panel-bg: #fdfaf2; /* è®°å½•çº¸å¼ è‰² */
            --table-header-bg: #667799; /* è®°å½•æ¿è“è‰² */
            --font-pixel: 'Press Start 2P', cursive;
            --font-stardew: 'DotGothic16', sans-serif;
            --court-yellow: #FFCC33; /* è¯æ®é»„è‰² */
        }

        /* --- å…¨å±€æ ·å¼å’ŒèƒŒæ™¯ (æ³•åº­èƒŒæ™¯) --- */
        body {
            font-family: var(--font-stardew);
            background-image: url('https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/6c74bad0ead845a88caf37c4f87420aa.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251121231553726E30B60DD9B8819A95&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1764342953&x-signature=LSNt9E7%2BG40BeV0XTY2kTY1crS8%3D');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden; 
        }

        .tracker-container {
            width: 100%;
            max-width: 900px;
            background: var(--panel-bg);
            border-radius: 0; /* æ¶ˆé™¤åœ†è§’ */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            padding: 25px;
            border: 5px solid var(--wood-dark); /* ç²—è¾¹æ¡† */
            position: relative;
            z-index: 10;
        }

        /* --- å¤´éƒ¨å’Œæ—¥æœŸé€‰æ‹© --- */
        header {
            text-align: center;
            margin-bottom: 25px;
            background: var(--header-bg);
            border-radius: 0;
            padding: 15px 10px;
            box-shadow: 0 5px 0 var(--wood-dark); /* 3Dæ•ˆæœ */
            border: 3px solid var(--wood-dark);
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        h1 {
            font-family: var(--font-pixel);
            color: var(--court-yellow);
            margin: 0;
            font-size: 1.6rem;
            text-shadow: 3px 3px var(--secondary-color); /* çº¢è‰²é˜´å½± */
        }
        h1::before {
            content: "ğŸš¨ å¼‚è®®ï¼";
            font-size: 1.2rem;
            margin-right: 15px;
            color: var(--secondary-color);
        }

        #date-selector {
            background-color: var(--panel-bg);
            border: 2px solid var(--wood-dark);
            border-radius: 0;
            padding: 8px 12px;
            font-family: var(--font-stardew);
            font-size: 0.9rem;
            color: var(--text-dark);
            cursor: pointer;
            margin-top: 10px;
        }

        /* --- æ•°æ®å¯è§†åŒ–åŒºåŸŸ --- */
        #chart-panel {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
            padding: 18px;
            background-color: #cfd8dc; /* è¯æ®å°æµ…è‰² */
            border-radius: 0;
            border: 3px dashed var(--wood-dark);
        }
        .chart-box {
            flex: 1;
            min-width: 300px;
        }
        .chart-box h3 {
            font-family: var(--font-pixel);
            font-size: 0.8rem;
            color: var(--primary-color);
            text-shadow: 1px 1px #fff;
        }
        .chart-container {
            height: 200px;
        }

        /* --- æ‰¹é‡æ“ä½œå’Œæ•°æ®ç®¡ç† (æ³•æ§Œæ“ä½œ) --- */
        #control-panel {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .control-group button, .data-button {
            background-color: var(--primary-color); /* è¾©æŠ¤è“è‰² */
            color: var(--text-light);
            border: none;
            border-bottom: 4px solid var(--wood-dark);
            border-right: 2px solid var(--wood-dark);
            border-radius: 0;
            padding: 10px 15px;
            cursor: pointer;
            font-family: var(--font-pixel); /* åƒç´ å­—ä½“ç”¨äºæŒ‰é’® */
            font-size: 0.7rem;
            transition: background-color 0.1s, transform 0.1s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .control-group button:active, .data-button:active {
            transform: translateY(2px);
            border-bottom: 2px solid var(--wood-dark);
        }

        /* --- è¡¨æ ¼æ ·å¼ (è¯ç‰©æ¸…å•) --- */
        .table-wrapper {
            max-height: 400px;
            overflow-y: auto;
            border: 3px solid var(--wood-dark);
            border-radius: 0;
            background-color: #f0f0f0;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        .student-table {
            width: 100%;
            border-collapse: collapse;
        }
        .student-table th, .student-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .student-table th {
            background-color: var(--table-header-bg);
            color: var(--court-yellow);
            text-shadow: 1px 1px var(--wood-dark);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .student-table tr:hover {
            background-color: #f5f5f5;
        }

        /* å¤é€‰æ¡†æ ·å¼ (è¯ç‰©å°ç« ) */
        .checkbox-container {
            display: block;
            position: relative;
            padding-left: 35px;
            margin-bottom: 12px;
            cursor: pointer;
            font-size: 22px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }
        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 25px;
            width: 25px;
            background-color: #d4d4d4; 
            border-radius: 0; /* å˜æ–¹ */
            border: 2px solid #888;
        }
        .checkbox-container:hover input ~ .checkmark {
            background-color: #ccc;
        }
        .checkbox-container input:checked ~ .checkmark { 
            background-color: var(--court-yellow); /* ç›–ç« åçš„é»„è‰² */
            border-color: #b39433;
        }
        .checkbox-container input.review:checked ~ .checkmark { 
            background-color: var(--secondary-color); /* å¼‚è®®çš„çº¢è‰² */
            border-color: #990000;
        }
        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }
        .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }
        .checkbox-container .checkmark:after {
            left: 9px;
            top: 5px;
            width: 8px;
            height: 15px;
            border: solid var(--wood-dark);
            border-width: 0 4px 4px 0;
            -webkit-transform: rotate(45deg);
            -ms-transform: rotate(45deg);
            transform: rotate(45deg);
        }
        
        /* --- NPC è¯„è¯­å¼¹çª— (æ³•åº­å¯¹è¯æ¡†) --- */
        #npc-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #npc-dialog-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .npc-dialog {
            background: #e0f2f1; /* æµ…é’è‰²å¯¹è¯æ¡† */
            border: 6px solid var(--primary-color); /* è“è‰²è¾¹æ¡† */
            box-shadow: 0 0 0 2px var(--wood-dark);
            border-radius: 0;
            max-width: 450px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
        }
        .npc-dialog::before {
            content: "";
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 15px 15px 15px;
            border-style: solid;
            border-color: transparent transparent var(--primary-color) transparent;
        }
        .npc-dialog img {
            width: 100px;
            height: 100px;
            border: 4px solid var(--secondary-color); /* çº¢è‰²è¾¹æ¡† */
            border-radius: 0;
            margin-bottom: 15px;
            object-fit: cover;
        }
        .npc-dialog h3 { 
            font-family: var(--font-pixel); 
            color: var(--secondary-color); 
            font-size: 1.3rem; 
            margin: 0 0 10px 0;
        }
        .npc-dialog p {
            font-family: var(--font-stardew);
            font-size: 1.1rem;
            color: var(--text-dark);
            margin: 0 0 20px 0;
            line-height: 1.4;
        }
        .npc-dialog button {
            background-color: var(--secondary-color); /* çº¢è‰²æŒ‰é’® */
            color: white;
            font-family: var(--font-pixel);
            font-size: 0.8rem;
            border: none;
            border-bottom: 3px solid #990000;
            border-radius: 0;
            padding: 8px 16px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .npc-dialog button:active {
            transform: translateY(2px);
            border-bottom: 1px solid #990000;
        }

        /* --- å“åº”å¼è®¾è®¡ --- */
        @media (max-width: 768px) {
            .tracker-container {
                padding: 15px;
                border-width: 3px;
            }
            h1 {
                font-size: 1.2rem;
            }
            #chart-panel {
                flex-direction: column;
                gap: 15px;
            }
            .chart-box {
                min-width: auto;
            }
            .control-group {
                width: 100%;
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }
            .control-group button, .data-button {
                flex: 1;
                min-width: 120px;
                justify-content: center;
            }
            .student-table th, .student-table td {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    
    <div class="tracker-container">
        <header>
            <h1>å­¦éœ¸æ³•åº­è®°å½•</h1>
            <input type="date" id="date-selector">
        </header>

        <div id="chart-panel">
            <div class="chart-box">
                <h3>å½“æ—¥è¯æ®å‘ˆä¸Šç‡ (å­¦ç”Ÿæ•° / æ€»æ•°)</h3>
                <div class="chart-container">
                    <canvas id="daily-completion-chart"></canvas>
                </div>
            </div>
            <div class="chart-box">
                <h3>å†å²è¾©æŠ¤è¶‹åŠ¿ (è¿‘7æ—¥)</h3>
                <div class="chart-container">
                    <canvas id="historical-trend-chart"></canvas>
                </div>
            </div>
        </div>
        
        <div id="control-panel">
            <div class="control-group">
                <button id="batch-recitation-toggle">
                    <i class="fa-solid fa-gavel"></i> å‘ˆä¸Šè¯æ® (å…¨é€‰/æ¸…ç©º)
                </button>
                <button id="batch-review-toggle">
                    <i class="fa-solid fa-hand-point-up"></i> æ ¸å¿ƒè¯è¨€ (å…¨é€‰/æ¸…ç©º)
                </button>
            </div>
            
            <div class="control-group">
                <button id="export-data" class="data-button">
                    <i class="fa-solid fa-file-export"></i> å¯¼å‡ºå·å®— (JSON)
                </button>
                <label for="import-file" class="data-button">
                    <i class="fa-solid fa-file-import"></i> å¯¼å…¥å·å®—
                </label>
                <input type="file" id="import-file" accept=".json" style="display: none;">
            </div>
        </div>

        <div class="table-wrapper">
            <table class="student-table" id="tracker-table">
                <thead>
                    <tr>
                        <th>ç¼–å·</th>
                        <th>å—å®¡å­¦ç”Ÿ</th>
                        <th>è¯ç‰© (Recitation)</th>
                        <th>è¯è¨€ (Review)</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
            </table>
        </div>
    </div>

    
    <div id="npc-dialog-overlay">
        <div class="npc-dialog">
            <img id="npc-avatar" src="" alt="è§’è‰²ç«‹ç»˜">
            <h3 id="npc-name"></h3>
            <p id="npc-quote"></p>
            <button onclick="hideNpcDialog()">æ˜ç™½äº†ï¼</button>
        </div>
    </div>

<script>
    // --- 1. å­¦ç”Ÿåå• (å·²æ›´æ–°) ---
    const STUDENT_LIST = [
        "stu1", "stu2", "stu3"
    ];
    const TOTAL_STUDENTS = STUDENT_LIST.length; // 49 äºº
    const STORAGE_KEY = 'aceAttorneyTaskTrackerData'; 

    // --- 2. è§’è‰²æ•°æ®å’Œå°è¯ (é€†è½¬è£åˆ¤ä¸»é¢˜) ---
    const NPC_DATA = [
        { name: "æˆæ­¥å ‚ é¾™ä¸€", image: "https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/e9cb0f8f2fff433c99744a9143356a82.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251121230214E24F9DDCD03F26C16B11&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1764342135&x-signature=LPlRj%2BvQmCxI1EP9olVNt939deo%3D", quotes: ["å¤ªæ£’äº†ï¼çœŸç›¸åªæœ‰ä¸€ä¸ªï¼Œè€Œä½ å°±æ˜¯è¯æ®ï¼", "è¿™æ˜¯å®Œç¾çš„è¯æ®ï¼Œæ³•åº­ä¼šæ¥çº³çš„ï¼"] },
        { name: "å¾¡å‰‘ æ€œä¾", image: "https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/0a361303ae70465f854959b46c03b086.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251121230214E24F9DDCD03F26C16B11&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1764342135&x-signature=Mlbx%2BSWhEoaJUdeAdZLop%2B2RL80%3D", quotes: ["å“¼ã€‚å‹‰å¼ºå¯ä»¥ä½œä¸ºè¯æ®å‘ˆä¸Šã€‚è®°ä½ï¼Œå®Œç¾ä¸»ä¹‰æ˜¯æˆ‘çš„ä¿¡æ¡ã€‚", "å¾ˆå¥½ï¼Œä½ æ²¡æœ‰è®©æˆ‘å¤±æœ›ã€‚è¿™æ¬¡æˆ‘ä¸ä¼šæå‡ºå¼‚è®®äº†ã€‚"] },
        { name: "ç»«é‡Œ çœŸå®µ", image: "https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/b0d5d6b74c284eb699ff569353209781.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251121230214E24F9DDCD03F26C16B11&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1764342135&x-signature=pAEzRhgPkf6k3wFsGWiddJxwTEY%3D", quotes: ["å“‡ï¼å¤ªå‰å®³äº†æˆæ­¥å ‚å›ï¼ä½ æˆåŠŸå°†è¯æ®å‘ˆä¸Šå»äº†å‘¢ï¼", "å•Šï¼Œè‚šå­é¥¿äº†ï¼ä½†çœ‹åˆ°ä½ å®Œæˆä»»åŠ¡ï¼Œæˆ‘çš„å¿ƒä¹Ÿè¢«æ²»æ„ˆäº†ï¼"] },
        { name: "æ³•å®˜", image: "https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/2de8316e0e7c41e98d259d3a83852ba5.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251121231553726E30B60DD9B8819A95&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1764342953&x-signature=ekz%2F%2B1wwvpBh5sXLpSDQoPbE44w%3D", quotes: ["å¾ˆå¥½ï¼Œæ³•åº­æ¥çº³äº†è¿™é¡¹è¯ç‰©ï¼è¯·ç»§ç»­ä¿æŒï¼", "åˆ¤ä½ é€šè¿‡ï¼è¿™æ˜¯æ³•åº­çš„å†³å®šï¼Œä¸å¯åŠ¨æ‘‡ï¼"] },
        { name: "ç‹©é­” å†¥", image: "https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/4723d6f0c4314acdac64f1e8af069509.jpg~tplv-a9rns2rl98-24:720:720.png?rcl=20251121230214E24F9DDCD03F26C16B11&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1764342135&x-signature=f8KywN6r%2FRPVYFeiI%2Bs%2FP6MWIgw%3D", quotes: ["é—­å˜´ï¼è¿™ç§ç¨‹åº¦çš„è¯ç‰©ï¼Œä¹Ÿé…è®©æˆ‘æŒ¥åŠ¨é­å­å—ï¼Ÿä¸è¿‡...åšå¾—è¿˜ç®—åˆæ ¼ã€‚", "ä½ çš„åŠªåŠ›æ²¡æœ‰ç™½è´¹ã€‚æˆ‘æ‰¿è®¤ä½ çš„æˆæœã€‚"] },
        { name: "ç³¸é”¯ åœ­ä»‹", image: "https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/fff7c2b5007a40e380c5da22aae827e6.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251121230214E24F9DDCD03F26C16B11&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1764342135&x-signature=lhxnSygoyQ4Q94hwtRFirZ3LxAk%3D", quotes: ["å¤šäºäº†ä½ ï¼Œæˆæ­¥å ‚å…ˆç”Ÿï¼è¿™ä¸ªè¯æ®èƒ½å¸®ä¸Šå¤§å¿™çš„ï¼åˆ‘è­¦çš„ç›´è§‰å‘Šè¯‰æˆ‘ï¼Œè¿™æ˜¯çœŸçš„ï¼", "å•Šå’§ï¼Ÿæˆ‘è‚šå­é¥¿äº†ã€‚ä¸è¿‡ï¼Œä½ çš„ä»»åŠ¡å®Œæˆäº†ï¼Œå¤ªå¥½äº†ï¼Œæ˜¯å§ï¼"] },
    ];

    // --- 3. çŠ¶æ€å˜é‡å’Œ Chart å®ä¾‹ ---
    let currentData = {}; 
    let dailyChart, historicalChart;

    // --- 4. DOM å…ƒç´ ç¼“å­˜ ---
    const dom = {};

    // --- 5. è¾…åŠ©å‡½æ•° ---

    /** æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD å­—ç¬¦ä¸² */
    function formatDate(dateObj) {
        const y = dateObj.getFullYear();
        const m = String(dateObj.getMonth() + 1).padStart(2, '0');
        const d = String(dateObj.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    /** è·å–æŒ‡å®šæ—¥æœŸå‰Nå¤©çš„æ—¥æœŸæ•°ç»„ (YYYY-MM-DD) */
    function getLastNDays(startDay, nDays) {
        const dates = [];
        let date = new Date(startDay);
        date.setDate(date.getDate() - (nDays - 1)); 

        for (let i = 0; i < nDays; i++) {
            dates.push(formatDate(date));
            date.setDate(date.getDate() + 1);
        }
        return dates;
    }

    // --- 6. æ•°æ®æŒä¹…åŒ– ---

    /** ä» localStorage åŠ è½½æ‰€æœ‰æ•°æ®ã€‚*/
    function loadAllData() {
        const stored = localStorage.getItem(STORAGE_KEY);
        try {
            return stored ? JSON.parse(stored) : {};
        } catch (e) {
            console.error("Error parsing stored data, returning empty object:", e);
            return {};
        }
    }

    /** ä¿å­˜å½“å‰æ—¥æœŸçš„æ•°æ®åˆ° localStorageã€‚*/
    function saveCurrentData() {
        const selectedDate = dom.dateSelector.value;
        if (!selectedDate) return;

        const allData = loadAllData();
        allData[selectedDate] = currentData;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
    }

    // --- 7. æ ¸å¿ƒæ¸²æŸ“å’ŒåŠ è½½é€»è¾‘ ---

    /** åŠ è½½å¹¶æ¸²æŸ“ç‰¹å®šæ—¥æœŸçš„ä»»åŠ¡çŠ¶æ€ã€‚*/
    function loadAndRender(dateString) {
        const allData = loadAllData();
        const savedDayData = allData[dateString] || {};

        currentData = {};

        STUDENT_LIST.forEach(name => {
            currentData[name] = savedDayData[name] || { recitation: false, review: false };
        });

        renderTable();
        updateCharts(allData);
    }

    /** æ¸²æŸ“å­¦ç”Ÿåˆ—è¡¨å’Œå¤é€‰æ¡†ã€‚*/
    function renderTable() {
        dom.tableBody.innerHTML = '';

        STUDENT_LIST.forEach((name, index) => {
            const status = currentData[name];
            const row = dom.tableBody.insertRow();
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${name}</td>
                <td>
                    <label class="checkbox-container">
                        <input type="checkbox" data-student="${name}" data-task="recitation" ${status.recitation ? 'checked' : ''}>
                        <span class="checkmark"></span>
                    </label>
                </td>
                <td>
                    <label class="checkbox-container">
                        <input type="checkbox" class="review" data-student="${name}" data-task="review" ${status.review ? 'checked' : ''}>
                        <span class="checkmark review"></span>
                    </label>
                </td>
            `;
        });
        document.querySelectorAll('#tracker-table input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', handleCheckboxChange);
        });
    }

    // --- 8. å›¾è¡¨å’Œå¯è§†åŒ– ---

    /**
     * åˆå§‹åŒ– Chart.js å®ä¾‹ã€‚
     */
    function initializeCharts(allData) {
        const dailyCtx = document.getElementById('daily-completion-chart').getContext('2d');
        const historicalCtx = document.getElementById('historical-trend-chart').getContext('2d');

        // 1. å½“æ—¥å®Œæˆç‡é¥¼å›¾ (Doughnut Chart)
        dailyChart = new Chart(dailyCtx, {
            type: 'doughnut',
            data: {
                labels: ['è¯ç‰©å‘ˆä¸Š', 'è¯ç‰©ç¼ºå¤±', 'è¯è¨€ç¡®è®¤', 'è¯è¨€å­˜ç–‘'],
                datasets: [{
                    data: [0, TOTAL_STUDENTS, 0, TOTAL_STUDENTS], 
                    backgroundColor: [
                        '#3b5998',      // è“è‰² (è¯ç‰©)
                        '#e0e0e0',      // ç°è‰² (ç¼ºå¤±)
                        '#cc0000',      // çº¢è‰² (è¯è¨€)
                        '#cccccc'       // æ·±ç°è‰² (å­˜ç–‘)
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { font: { family: 'var(--font-stardew)' } }
                    },
                    title: { display: false }
                }
            }
        });

        // 2. å†å²è¶‹åŠ¿å›¾ (Line Chart)
        historicalChart = new Chart(historicalCtx, {
            type: 'line',
            data: {
                labels: [], 
                datasets: [
                    {
                        label: 'è¯ç‰©å‘ˆä¸Šç‡ (%)',
                        data: [],
                        borderColor: '#3b5998',
                        backgroundColor: 'rgba(59, 89, 152, 0.2)',
                        tension: 0.2
                    },
                    {
                        label: 'è¯è¨€ç¡®è®¤ç‡ (%)',
                        data: [],
                        borderColor: '#cc0000',
                        backgroundColor: 'rgba(204, 0, 0, 0.2)',
                        tension: 0.2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        title: { display: true, text: 'å®Œæˆç‡ (%)' }
                    }
                },
                plugins: {
                    legend: { position: 'bottom' },
                    title: { display: false }
                }
            }
        });
        
        updateCharts(allData);
    }

    /** * è®¡ç®—å¹¶æ›´æ–°æ‰€æœ‰å›¾è¡¨æ•°æ®ã€‚
     * @param {object} allData æ‰€æœ‰å†å²æ•°æ®
     */
    function updateCharts(allData) {
        if (!dailyChart || !historicalChart) return;

        // --- 1. è®¡ç®—å½“æ—¥å®Œæˆç‡ ---
        let recitationCompleted = 0;
        let reviewCompleted = 0;

        STUDENT_LIST.forEach(name => {
            if (currentData[name].recitation) recitationCompleted++;
            if (currentData[name].review) reviewCompleted++;
        });

        // Pie Chart Data - ç›´æ¥ä½¿ç”¨å­¦ç”Ÿæ•°é‡
        dailyChart.data.datasets[0].data = [
            recitationCompleted, 
            TOTAL_STUDENTS - recitationCompleted, 
            reviewCompleted, 
            TOTAL_STUDENTS - reviewCompleted
        ];
        dailyChart.update();
        
        // --- 2. è®¡ç®—å†å²è¶‹åŠ¿å›¾æ•°æ® ---
        const today = dom.dateSelector.value;
        const last7Days = getLastNDays(today, 7);
        const recitationRates = [];
        const reviewRates = [];

        last7Days.forEach(date => {
            const dayData = allData[date] || {};
            let rCount = 0;
            let rvCount = 0;
            
            STUDENT_LIST.forEach(name => {
                const status = dayData[name];
                if (status && status.recitation) rCount++;
                if (status && status.review) rvCount++;
            });

            // è®¡ç®—ç™¾åˆ†æ¯”å¹¶ä¿ç•™ä¸€ä½å°æ•°
            const rRate = TOTAL_STUDENTS > 0 ? (rCount / TOTAL_STUDENTS) * 100 : 0;
            const rvRate = TOTAL_STUDENTS > 0 ? (rvCount / TOTAL_STUDENTS) * 100 : 0;

            recitationRates.push(parseFloat(rRate.toFixed(1)));
            reviewRates.push(parseFloat(rvRate.toFixed(1)));
        });

        // Line Chart Data
        historicalChart.data.labels = last7Days.map(d => d.substring(5)); // æ˜¾ç¤º æœˆ-æ—¥ (M-D)
        historicalChart.data.datasets[0].data = recitationRates;
        historicalChart.data.datasets[1].data = reviewRates;
        historicalChart.update();
    }

    // --- 9. è§’è‰²å¯¹è¯åŠŸèƒ½ ---

    function showNpcDialog(npcName, quote) {
        // ä½¿ç”¨includesæ¥åŒ¹é…åŒ…å«ä¸­æ–‡åçš„NPC
        const npc = NPC_DATA.find(n => n.name.includes(npcName.split('(')[0].trim()));
        if (!npc) {
            const defaultNpc = NPC_DATA.find(n => n.name.includes("æ³•å®˜"));
            dom.npcAvatar.src = defaultNpc.image;
            dom.npcName.textContent = defaultNpc.name;
            dom.npcQuote.textContent = "æ³•åº­ç›¸ä¿¡ä½ çš„åˆ¤æ–­ï¼è¿™ä¸ªè¯æ®/è¯è¨€å°†è¢«è®°å½•åœ¨æ¡ˆï¼";
        } else {
            dom.npcAvatar.src = npc.image;
            dom.npcAvatar.alt = npc.name;
            dom.npcName.textContent = npc.name;
            dom.npcQuote.textContent = quote;
        }

        dom.npcDialogOverlay.classList.add('show');
    }

    window.hideNpcDialog = function() {
        dom.npcDialogOverlay.classList.remove('show');
    }

    function getRandomNpcComment() {
        const randomNpc = NPC_DATA[Math.floor(Math.random() * NPC_DATA.length)];
        const randomQuote = randomNpc.quotes[Math.floor(Math.random() * randomNpc.quotes.length)];
        return { name: randomNpc.name, quote: randomQuote };
    }


    // --- 10. äº‹ä»¶å¤„ç† ---

    /** å¤„ç†å•ä¸ªå¤é€‰æ¡†å˜åŒ–ã€‚*/
    function handleCheckboxChange(event) {
        const checkbox = event.target;
        const studentName = checkbox.dataset.student;
        const task = checkbox.dataset.task;
        const isChecked = checkbox.checked;

        if (currentData[studentName]) {
            const previousState = currentData[studentName][task];
            currentData[studentName][task] = isChecked;

            saveCurrentData();
            updateCharts(loadAllData()); 

            if (isChecked && !previousState) {
                const { name, quote } = getRandomNpcComment();
                showNpcDialog(name, quote);
            }
        }
    }
    
    /**
     * æ‰¹é‡åˆ‡æ¢ä»»åŠ¡çŠ¶æ€ã€‚
     */
    function handleBatchToggle(taskType) {
        const checkboxes = document.querySelectorAll(`input[data-task="${taskType}"]`);
        
        const shouldCheckAll = Array.from(checkboxes).some(cb => !cb.checked);
        
        checkboxes.forEach(checkbox => {
            if (checkbox.checked !== shouldCheckAll) {
                checkbox.checked = shouldCheckAll;
                const studentName = checkbox.dataset.student;
                currentData[studentName][taskType] = shouldCheckAll;
            }
        });

        saveCurrentData();
        updateCharts(loadAllData());
        
        const taskName = taskType === 'recitation' ? 'è¯ç‰©' : 'è¯è¨€';
        alert(`ğŸš¨ å¼‚è®®ï¼æ³•åº­å·²ä¸‹ä»¤ï¼Œå¯¹æ‰€æœ‰å­¦ç”Ÿçš„ã€${taskName}ã€‘æ‰§è¡Œ${shouldCheckAll ? 'å‘ˆä¸Š' : 'æ¸…ç©º'}ï¼`);
    }

    // --- 11. æ•°æ®å¯¼å…¥/å¯¼å‡º (å·å®—ç®¡ç†) ---

    /** å¯¼å‡ºæ‰€æœ‰æ•°æ®ä¸º JSON æ–‡ä»¶ã€‚*/
    function exportData() {
        const allData = loadAllData();
        const jsonString = JSON.stringify(allData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        
        const fileName = `ace_attorney_case_file_${formatDate(new Date())}.json`;
        
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
        
        alert("å·å®—å·²æˆåŠŸå¯¼å‡ºä¸º " + fileName + "ã€‚è¯·å¦¥å–„ä¿ç®¡ï¼");
    }

    /** å¯¼å…¥ JSON æ–‡ä»¶ä¸­çš„æ•°æ®ã€‚*/
    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (typeof importedData !== 'object' || Array.isArray(importedData)) {
                    throw new Error("å¯¼å…¥çš„å·å®—æ ¼å¼ä¸æ­£ç¡®ã€‚");
                }
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData));
                
                const currentDay = dom.dateSelector.value;
                loadAndRender(currentDay);
                alert("æ³•åº­å·å®—å¯¼å…¥æˆåŠŸï¼æ‰€æœ‰è®°å½•å·²æ›´æ–°ã€‚");

            } catch (error) {
                console.error("å·å®—å¯¼å…¥å¤±è´¥:", error);
                alert("å·å®—å¯¼å…¥å¤±è´¥ã€‚è¯·ç¡®ä¿æ–‡ä»¶æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼ã€‚\né”™è¯¯ä¿¡æ¯: " + error.message);
            }
        };
        reader.readAsText(file);
    }


    // --- 12. åˆå§‹åŒ– ---

    function initialize() {
        // ç¼“å­˜ DOM å…ƒç´ 
        dom.dateSelector = document.getElementById('date-selector');
        dom.tableBody = document.getElementById('table-body');
        dom.npcDialogOverlay = document.getElementById('npc-dialog-overlay');
        dom.npcAvatar = document.getElementById('npc-avatar');
        dom.npcName = document.getElementById('npc-name');
        dom.npcQuote = document.getElementById('npc-quote');

        // è®¾ç½®é»˜è®¤æ—¥æœŸå’Œæœ€å¤§æ—¥æœŸ
        const today = new Date();
        const todayString = formatDate(today);
        dom.dateSelector.value = todayString;
        dom.dateSelector.max = todayString;

        // ç›‘å¬äº‹ä»¶
        dom.dateSelector.addEventListener('change', (e) => loadAndRender(e.target.value));
        document.getElementById('batch-recitation-toggle').addEventListener('click', () => handleBatchToggle('recitation'));
        document.getElementById('batch-review-toggle').addEventListener('click', () => handleBatchToggle('review'));
        document.getElementById('export-data').addEventListener('click', exportData);
        document.getElementById('import-file').addEventListener('change', importData);

        // é¦–æ¬¡åŠ è½½å’Œæ¸²æŸ“
        const allData = loadAllData();
        loadAndRender(todayString);
        initializeCharts(allData);
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œåˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initialize);

</script>

</body>
</html>
